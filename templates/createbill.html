
<!DOCTYPE html>
<html>
<head>
  <title>Create Bill</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">

<div class="max-w-5xl mx-auto mt-8 bg-white p-6 rounded-lg shadow">

<h2 class="text-xl font-bold mb-4">Create New Bill</h2>

<div class="grid grid-cols-2 gap-4 mb-4">
  <div>
    <label class="block text-sm font-medium">Bill Number</label>
    <input id="bill_no" class="w-full border p-2 rounded">
  </div>
  <div>
    <label class="block text-sm font-medium">Date</label>
    <input type="date" id="bill_date" class="w-full border p-2 rounded">
  </div>
</div>

<h3 class="font-semibold mb-2">Customer Details</h3>

<div class="mb-3">
  <label class="block text-sm font-medium">Customer Name</label>
  <input id="customer_name" class="w-full border p-2 rounded">
</div>

<div class="mb-3">
  <label class="block text-sm font-medium">Address</label>
  <input id="address" class="w-full border p-2 rounded">
</div>

<div class="mb-4">
  <label class="block text-sm font-medium">Phone</label>
  <input id="phone" class="w-full border p-2 rounded">
</div>

<div class="flex justify-between items-center mb-2">
  <h3 class="font-semibold">Items</h3>
  <button onclick="addRow()" class="bg-green-600 text-white px-3 py-1 rounded">+ Add Item</button>
</div>

<table class="w-full border">
<thead class="bg-gray-200">
<tr>
  <th class="p-2 border">Description</th>
  <th class="p-2 border">Quantity</th>
  <th class="p-2 border">Rate</th>
  <th class="p-2 border">Amount</th>
  <th class="p-2 border">Action</th>
</tr>
</thead>
<tbody id="itemTable">
<tr>
  <td class="p-1 border"><input class="desc w-full border p-1"></td>
  <td class="p-1 border"><input type="number" class="qty w-full border p-1" value="0" oninput="calculate()"></td>
  <td class="p-1 border"><input type="number" class="rate w-full border p-1" value="0" oninput="calculate()"></td>
  <td class="p-1 border"><input class="amount w-full border p-1" value="0" readonly></td>
  <td class="p-1 border text-center">
    <button onclick="deleteRow(this)" class="bg-red-500 text-white px-2 py-1 rounded">ðŸ—‘</button>
  </td>
</tr>
</tbody>
</table>

<h3 class="font-semibold mt-4 mb-2">Tax Configuration</h3>

<div class="grid grid-cols-2 gap-4 mb-4">
  <div>
    <label class="block text-sm font-medium">Tax Rate (%)</label>
    <input id="tax" value="0" oninput="calculate()" class="w-full border p-2 rounded">
  </div>
  <div>
    <label class="block text-sm font-medium">GST Rate (%)</label>
    <input id="gst" value="0" oninput="calculate()" class="w-full border p-2 rounded">
  </div>
</div>

<div class="text-right">
  <p>Subtotal: â‚¹<span id="subtotal">0</span></p>
  <p>Tax: â‚¹<span id="tax_amount">0</span></p>
  <p>GST: â‚¹<span id="gst_amount">0</span></p>
  <h3 class="text-lg font-bold">Total: â‚¹<span id="total">0</span></h3>
</div>

<div class="flex justify-end gap-3 mt-4">
  <button onclick="window.location='/dashboard/'" class="bg-gray-400 text-white px-4 py-2 rounded">Cancel</button>
  <button onclick="saveBill()" class="bg-blue-700 text-white px-4 py-2 rounded">Save Bill</button>
</div>

</div>

<script>
function addRow(){
  const row = document.createElement("tr");
  row.innerHTML = `
  <td class="p-1 border"><input class="desc w-full border p-1"></td>
  <td class="p-1 border"><input type="number" class="qty w-full border p-1" value="0" oninput="calculate()"></td>
  <td class="p-1 border"><input type="number" class="rate w-full border p-1" value="0" oninput="calculate()"></td>
  <td class="p-1 border"><input class="amount w-full border p-1" value="0" readonly></td>
  <td class="p-1 border text-center">
    <button onclick="deleteRow(this)" class="bg-red-500 text-white px-2 py-1 rounded">ðŸ—‘</button>
  </td>
  `;
  document.getElementById("itemTable").appendChild(row);
}

function deleteRow(btn){
  btn.closest("tr").remove();
  calculate();
}

function calculate(){
  let subtotal = 0;

  document.querySelectorAll("#itemTable tr").forEach(row=>{
    let qty = row.querySelector(".qty").value;
    let rate = row.querySelector(".rate").value;
    let amount = qty * rate;
    row.querySelector(".amount").value = amount;
    subtotal += amount;
  });

  let taxRate = document.getElementById("tax").value;
  let gstRate = document.getElementById("gst").value;

  let taxAmount = subtotal * taxRate / 100;
  let gstAmount = subtotal * gstRate / 100;
  let total = subtotal + taxAmount + gstAmount;

  document.getElementById("subtotal").innerText = subtotal;
  document.getElementById("tax_amount").innerText = taxAmount;
  document.getElementById("gst_amount").innerText = gstAmount;
  document.getElementById("total").innerText = total;
}
async function saveBill(){
const billData = {
  customer_name: document.getElementById("customer_name").value,
  items: []
};

document.querySelectorAll("#itemTable tr").forEach(row=>{
  billData.items.push({
    product_id: row.querySelector(".desc").value,   // TEMP: use product id here
    quantity: Number(row.querySelector(".qty").value),
    price: Number(row.querySelector(".rate").value)
  });
});


  const res = await fetch("/api/create-bill/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + localStorage.getItem("access")
    },
    body: JSON.stringify(billData)
  });

  if(res.ok){
    alert("Bill saved successfully!");
    window.location.href = "/dashboard/";
  } else {
    alert("Error saving bill");
  }
}

</script>

</body>
</html>
