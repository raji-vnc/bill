
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Billing Management - Admin Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
</style>
</head>

<body class="p-6 md:p-10">

<header class="flex justify-between items-center mb-10">
<div>
<h1 class="text-3xl font-bold text-gray-900">Billing Management System</h1>
<p class="text-gray-500 text-sm mt-1">Admin Dashboard</p>
</div>
<button onclick="logout()" class="px-4 py-2 bg-white border rounded-lg">Logout</button>
</header>

<div class="bg-white rounded-2xl border shadow-sm p-6">
<div class="flex justify-between items-center mb-6">
<h3 class="text-lg font-bold">All Bills</h3>
<button onclick="gotoCreatebill()" class="bg-black text-white px-4 py-2 rounded-lg">+ Create New Bill</button>
</div>

<div class="overflow-x-auto">
<table class="w-full text-left text-sm">
<thead class="border-b">
<tr>
<th class="pb-3">Bill No</th>
<th>Date</th>
<th>Customer</th>
<th>Item</th>
<th>Phone</th>
<th class="text-right">Qty</th>
<th class="text-right">Subtotal</th>
<th class="text-right">Tax</th>
<th class="text-right">GST</th>
<th class="text-right">Total</th>
<th class="text-center">Actions</th>
</tr>
</thead>

<tbody class="divide-y">
<!-- Rows will be inserted here by JavaScript -->
</tbody>
</table>
</div>
</div>

<script>
async function loadBills() {
const token = localStorage.getItem("access");

if (!token) {
window.location.href = "/login/";
return;
}

const res = await fetch("http://127.0.0.1:8000/api/bills/", {
headers: { "Authorization": "Bearer " + token }
});

if (res.status === 401) {
window.location.href = "/login/";
return;
}

const bills = await res.json();
const tableBody = document.querySelector("tbody");
tableBody.innerHTML = "";

bills.forEach(bill => {

  // ---- Get first item safely ----
  const firstItem = bill.items.length > 0 ? bill.items[0] : null;

  const itemName = firstItem 
      ? firstItem.product.name 
      : "-";

  const quantity = firstItem 
      ? firstItem.quantity 
      : 0;

  const price = firstItem 
      ? firstItem.price 
      : 0;

  // Correct subtotal
  const subtotal = Number(bill.total_price || bill.total || 0);

  const tax = Number(bill.tax || 0);
  const gst = Number(bill.gst || 0);
  const grandTotal = subtotal + tax + gst;

  const row = `
  <tr>
    <td>${bill.bill_no || "BILL-" + bill.id}</td>

    <td>
      ${new Date(bill.date).toLocaleDateString("en-IN")}
    </td>

    <td>${bill.customer_name || ""}</td>

    <td>${itemName}</td>

    <td>${bill.phone || "-"}</td>
    <td class="text-right">${quantity}</td>

    <td class="text-right">₹${subtotal.toFixed(2)}</td>

    <td class="text-right">₹${tax.toFixed(2)}</td>

    <td class="text-right">₹${gst.toFixed(2)}</td>

    <td class="text-right font-bold">
      ₹${grandTotal.toFixed(2)}
    </td>

    <td>
      <button onclick="viewBill(${bill.id})">View</button>
      <button onclick="printBill(${bill.id})">Print</button>
    </td>
  </tr>
  `;

  tableBody.innerHTML += row;
});

}

function viewBill(id){
window.location.href = `/bill-detail/${id}/`;
}

function printBill(id){
window.open(`/bill-print/${id}/`, "_blank");
}

function gotoCreatebill(){
window.location.href = "/create-bill/";
}

// VERY IMPORTANT — load data when page opens
loadBills();
</script>

</body>
</html>
